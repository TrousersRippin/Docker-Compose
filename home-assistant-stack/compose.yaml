---
services:
  mosquitto:
    image: docker.io/library/eclipse-mosquitto:latest
    container_name: mosquitto
    hostname: mosquitto
    restart: unless-stopped
    network_mode: host
    security_opt:
      - no-new-privileges:true
    environment:
      - TZ=Europe/Stockholm
    ports:
      - 1883:1883/tcp
    volumes:
      - $HOME/containers/storage/mosquitto/config:/mosquitto/config:rw,Z
      - $HOME/containers/storage/mosquitto/config/log:/mosquitto/log:rw,Z
      - $HOME/containers/storage/mosquitto/data:/mosquitto/data:rw,Z
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    networks:
      - proxy
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - logging=promtail
      - logging_jobname=containerlogs

  zigbee2mqtt:
    image: docker.io/koenkk/zigbee2mqtt:latest
    container_name: zigbee2mqtt
    hostname: zigbee2mqtt
    restart: unless-stopped
    network_mode: host
    security_opt:
      - no-new-privileges:true
    group_add:
      - dialout
    environment:
      - TZ=Europe/Stockholm
      - PUID=1000
      - PGID=1000
      - Z2M_WATCHDOG=1
    ports:
      - 8888:8888/tcp
    volumes:
      - $HOME/containers/storage/zigbee2mqtt/config:/app/data:rw,Z
      - /run/udev:/run/udev:ro
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    networks:
      - proxy
    depends_on:
      - mosquitto
    devices:
      - /dev/serial/by-id/usb-Silicon_Labs_Sonoff_Zigbee_3.0_USB_Dongle_Plus_0001-if00-port0:/dev/ttyUSB0
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - logging=promtail
      - logging_jobname=containerlogs

  home-assistant:
    image: docker.io/homeassistant/home-assistant:latest
    container_name: home-assistant
    hostname: home-assistant
    restart: unless-stopped
    network_mode: host
    privileged: true
    environment:
      - TZ=Europe/Stockholm
      - PUID=1000
      - PGID=1000
    ports:
      - 8123:8123/tcp
    volumes:
      - $HOME/containers/storage/home-assistant/config:/config:rw,Z
      - /run/dbus:/run/dbus:ro
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    networks:
      - proxy
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - logging=promtail
      - logging_jobname=containerlogs

networks:
  proxy:
    external: true